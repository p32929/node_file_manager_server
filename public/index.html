<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple File Upload Server</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* Basic styling for demo */
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3f37c9;
      --gray: #e9ecef;
      --gray-dark: #6c757d;
      --gray-light: #f8f9fa;
      --text: #212529;
      --warning: #f72585;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--gray-light);
      margin: 0; padding: 0;
      color: var(--text);
    }
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      padding: 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 0 0 15px 15px;
    }
    header h1 { margin: 0; font-size: 26px; }
    header p { margin: 5px 0 0; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .card-header {
      background: var(--gray);
      padding: 15px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-body { padding: 20px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background: var(--primary);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
      margin-right: 5px;
    }
    button:hover {
      background: var(--primary-dark);
    }
    button.secondary {
      background: var(--gray-dark);
    }
    .breadcrumb {
      display: flex;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .breadcrumb span {
      color: var(--primary-dark);
      cursor: pointer;
    }
    .folder-list {
      display: flex; flex-wrap: wrap; gap: 10px;
    }
    .folder {
      padding: 10px 15px; background: #fff; border: 1px solid var(--gray);
      border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .folder:hover { background: var(--gray); }
    .file-input-area {
      border: 2px dashed var(--gray-dark);
      padding: 30px; text-align: center; border-radius: 8px;
      background: var(--gray-light);
      cursor: pointer;
      margin-bottom: 10px;
    }
    .progress-container {
      height: 20px; background: #ddd; border-radius: 8px; overflow: hidden;
      margin: 10px 0; width: 100%;
    }
    .progress-bar {
      height: 100%; width: 0%; background: #28a745; transition: width 0.3s;
    }
    #toast {
      position: fixed; bottom: 20px; left: 20px;
      background: #333; color: #fff; padding: 10px 15px;
      border-radius: 8px; display: flex; align-items: center; gap: 10px;
      opacity: 0; transform: translateY(100px); transition: all 0.3s;
      z-index: 9999;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.success { background: green; }
    #toast.error { background: #dc3545; }
    #toast.info { background: var(--primary); }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-cloud-upload-alt"></i> Simple File Upload Server</h1>
    <p>Upload files to any folder on your server</p>
  </header>
  <div class="container">
    <!-- Explorer card -->
    <div class="card" id="explorerCard">
      <div class="card-header">
        <div>File Explorer</div>
        <button class="secondary" onclick="showHelp()">Help</button>
      </div>
      <div class="card-body">
        <div class="breadcrumb" id="breadcrumb"></div>
        <div id="folderContainer">
          <div>Loading folders...</div>
        </div>
        <div style="margin-top: 15px;">
          <button onclick="goBack()">Back</button>
          <button onclick="goUp()">Up</button>
          <button onclick="selectCurrentFolder()">Select This Folder</button>
        </div>
      </div>
    </div>
    <!-- Upload card -->
    <div class="card" id="uploadCard" style="display:none;">
      <div class="card-header">Upload File</div>
      <div class="card-body">
        <p>Selected folder: <span id="selectedFolderPath"></span></p>
        <div class="file-input-area" 
             id="dropZone" 
             onclick="document.getElementById('fileInput').click()">
          <p>Click or drag & drop a file here to upload</p>
        </div>
        <input type="file" id="fileInput" style="display:none;" onchange="onFileSelected()" />
        <div id="fileInfo"></div>
        <button id="startUploadBtn" onclick="startUpload()" style="display:none;">
          Upload
        </button>
        <div class="progress-container" id="uploadProgress" style="display:none;">
          <div class="progress-bar" id="uploadProgressBar"></div>
        </div>
        <div id="uploadStatus" style="font-size:14px; margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Simple toast -->
  <div id="toast"><i class="fas fa-check-circle"></i><span id="toastMsg"></span></div>

  <script>
    const API_BASE = window.location.origin;
    let currentPath = '/';
    let historyStack = [];

    window.addEventListener('load', () => {
      loadFolders('/');
    });

    function loadFolders(dir, pushHistory=true) {
      const container = document.getElementById('folderContainer');
      container.innerHTML = '<div>Loading...</div>';
      if (pushHistory && currentPath !== dir) {
        historyStack.push(currentPath);
      }
      fetch(`/list-folders?path=${encodeURIComponent(dir)}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            container.innerHTML = `<div style="color:red;">Error: ${data.error}</div>`;
            return;
          }
          currentPath = data.path;
          if (data.isRoot) {
            // On Windows root, fetch drives
            return loadDrives();
          }
          updateBreadcrumb(currentPath);
          if (!data.folders || data.folders.length === 0) {
            container.innerHTML = `<div>No subfolders here.</div>`;
          } else {
            container.innerHTML = '';
            const list = document.createElement('div');
            list.className = 'folder-list';
            data.folders.forEach(folderName => {
              const div = document.createElement('div');
              div.className = 'folder';
              div.innerText = folderName;
              div.onclick = () => {
                loadFolders(pathJoin(currentPath, folderName));
              };
              list.appendChild(div);
            });
            container.appendChild(list);
          }
        })
        .catch(err => {
          container.innerHTML = `<div style="color:red;">Failed to load folders: ${err}</div>`;
        });
    }

    function loadDrives() {
      fetch('/list-drives')
        .then(r => r.json())
        .then(data => {
          updateBreadcrumb('My Computer');
          const container = document.getElementById('folderContainer');
          container.innerHTML = '';
          if (data.drives && data.drives.length) {
            const list = document.createElement('div');
            list.className = 'folder-list';
            data.drives.forEach(drv => {
              const div = document.createElement('div');
              div.className = 'folder';
              div.innerText = drv;
              div.onclick = () => loadFolders(drv);
              list.appendChild(div);
            });
            container.appendChild(list);
          } else {
            container.innerHTML = 'No drives found.';
          }
        })
        .catch(err => {
          document.getElementById('folderContainer').innerHTML = 
            `<div style="color:red;">Error loading drives: ${err}</div>`;
        });
    }

    function goBack() {
      if (historyStack.length === 0) {
        showToast('No previous folder', 'info');
        return;
      }
      const prev = historyStack.pop();
      loadFolders(prev, false);
    }

    function goUp() {
      if (currentPath === '/' || currentPath === 'My Computer') {
        showToast('Already at root', 'info');
        return;
      }
      // If windows drive
      if (/^[A-Za-z]:\\?$/.test(currentPath)) {
        loadFolders('/'); // go back to "My Computer"
        return;
      }
      const parts = currentPath.split(/[\\/]/).filter(Boolean);
      parts.pop();
      let upPath = parts.join('/');
      if (upPath === '') upPath = '/';
      loadFolders(upPath);
    }

    function updateBreadcrumb(label) {
      const bc = document.getElementById('breadcrumb');
      bc.innerHTML = `<span>${label}</span>`;
    }

    function pathJoin(base, folder) {
      if (base === '/') return '/' + folder;
      // For Windows:
      if (/^[A-Za-z]:\\?$/.test(base)) {
        return base.replace(/\\?$/, '') + '\\' + folder;
      }
      // Normal path
      return base.replace(/\/$/, '') + '/' + folder;
    }

    function selectCurrentFolder() {
      document.getElementById('uploadCard').style.display = 'block';
      document.getElementById('selectedFolderPath').textContent = currentPath;
      showToast('Folder selected: ' + currentPath, 'info');
      // Reset upload UI
      document.getElementById('fileInfo').innerHTML = '';
      document.getElementById('startUploadBtn').style.display = 'none';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadStatus').innerHTML = '';
    }

    // File selection + upload
    let selectedFile = null;
    function onFileSelected() {
      const input = document.getElementById('fileInput');
      selectedFile = input.files[0];
      if (!selectedFile) return;
      document.getElementById('fileInfo').innerHTML = `
        <div><strong>File:</strong> ${selectedFile.name} (${formatSize(selectedFile.size)})</div>`;
      document.getElementById('startUploadBtn').style.display = 'inline-block';
    }

    function startUpload() {
      if (!selectedFile) {
        showToast('No file selected', 'error');
        return;
      }
      const folder = currentPath;
      if (!folder) {
        showToast('No target folder', 'error');
        return;
      }

      // Decide single-chunk vs multi-chunk
      const MAX_SINGLE_CHUNK_SIZE = 10 * 1024 * 1024; // 10MB
      if (selectedFile.size <= MAX_SINGLE_CHUNK_SIZE) {
        // single chunk
        uploadSingleChunk(selectedFile, folder);
      } else {
        // multi-chunk
        uploadMultiChunk(selectedFile, folder);
      }
    }

    function uploadSingleChunk(file, folder) {
      showToast(`Uploading ${file.name} (single chunk)`, 'info');
      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('uploadProgressBar').style.width = '0%';
      document.getElementById('uploadStatus').textContent = 'Uploading...';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', `/upload-chunk?path=${encodeURIComponent(folder)}`, true);
      xhr.setRequestHeader('X-File-Name', encodeURIComponent(file.name));
      xhr.setRequestHeader('X-Chunk-Index', '0');
      xhr.setRequestHeader('X-Total-Chunks', '1');
      xhr.setRequestHeader('X-Chunk-Size', file.size);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = (e.loaded / e.total) * 100;
          document.getElementById('uploadProgressBar').style.width = pct + '%';
        }
      };
      xhr.onload = () => {
        if (xhr.status === 200) {
          try {
            const resp = JSON.parse(xhr.responseText);
            if (resp.success) {
              document.getElementById('uploadProgressBar').style.width = '100%';
              document.getElementById('uploadStatus').textContent = 'Upload complete';
              showToast('Upload complete!', 'success');
            } else {
              showToast(resp.error || 'Server error', 'error');
            }
          } catch {
            showToast('Invalid response from server', 'error');
          }
        } else {
          showToast(`Error: ${xhr.status}`, 'error');
        }
      };
      xhr.onerror = () => {
        showToast('Network error', 'error');
      };

      xhr.send(file);
    }

    // MULTI-CHUNK
    let chunkSize = 5 * 1024 * 1024;
    let currentChunkIndex = 0;
    let totalChunks = 0;
    let fileId = null;

    function uploadMultiChunk(file, folder) {
      // Setup UI
      showToast(`Uploading ${file.name} (multi-chunk)`, 'info');
      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('uploadProgressBar').style.width = '0%';
      document.getElementById('uploadStatus').textContent = 'Preparing...';

      // Setup state
      chunkSize = 5 * 1024 * 1024; // 5MB chunks
      totalChunks = Math.ceil(file.size / chunkSize);
      currentChunkIndex = 0;
      fileId = Date.now().toString(); // or any unique ID

      // Start
      uploadNextChunk(file, folder);
    }

    function uploadNextChunk(file, folder) {
      if (currentChunkIndex >= totalChunks) {
        // done
        showToast('All chunks sent!', 'info');
        return;
      }
      const start = currentChunkIndex * chunkSize;
      const end = Math.min(file.size, start + chunkSize);
      const blob = file.slice(start, end);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', `/upload-chunk?path=${encodeURIComponent(folder)}`, true);
      xhr.setRequestHeader('X-File-Name', encodeURIComponent(file.name));
      xhr.setRequestHeader('X-Chunk-Index', currentChunkIndex);
      xhr.setRequestHeader('X-Total-Chunks', totalChunks);
      xhr.setRequestHeader('X-File-Id', fileId);
      xhr.setRequestHeader('X-Chunk-Size', blob.size);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const chunkPercent = e.loaded / e.total;
          const overallBytes = (currentChunkIndex * chunkSize) + e.loaded;
          const overallPercent = Math.floor((overallBytes / file.size) * 100);
          document.getElementById('uploadProgressBar').style.width = overallPercent + '%';
          document.getElementById('uploadStatus').textContent = 
            `Chunk ${currentChunkIndex+1}/${totalChunks} - ${overallPercent}% overall`;
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          try {
            const resp = JSON.parse(xhr.responseText);
            if (!resp.success) {
              showToast(resp.error || 'Server error chunk', 'error');
              return;
            }
            // success
            if (currentChunkIndex === totalChunks - 1) {
              // last chunk => server finalizes
              document.getElementById('uploadProgressBar').style.width = '100%';
              document.getElementById('uploadStatus').textContent = 'Upload complete';
              showToast('Upload complete!', 'success');
            } else {
              currentChunkIndex++;
              uploadNextChunk(file, folder);
            }
          } catch {
            showToast('Invalid JSON response from server', 'error');
          }
        } else {
          showToast(`Error uploading chunk ${currentChunkIndex}`, 'error');
        }
      };
      xhr.onerror = () => {
        showToast(`Network error chunk ${currentChunkIndex}`, 'error');
      };
      xhr.send(blob);
    }

    // Drag drop
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '#4361ee';
    });
    dropZone.addEventListener('dragleave', e => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '';
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.style.borderColor = '';
      if (e.dataTransfer.files.length) {
        document.getElementById('fileInput').files = e.dataTransfer.files;
        onFileSelected();
      }
    });

    // Toast
    function showToast(msg, type='info', duration=4000) {
      const toast = document.getElementById('toast');
      const icon = toast.querySelector('i');
      const text = document.getElementById('toastMsg');
      text.textContent = msg;
      toast.className = ''; // reset
      if (type==='success') icon.className = 'fas fa-check-circle';
      else if (type==='error') icon.className = 'fas fa-times-circle';
      else icon.className = 'fas fa-info-circle';

      toast.classList.add(type);
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function formatSize(bytes) {
      if (bytes===0) return '0 B';
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
    }

    function showHelp() {
      alert('1) Navigate to folder.\n2) Select folder.\n3) Choose file.\n4) Click upload.\nLarge files use multi-chunk to avoid corruption.');
    }
  </script>
</body>
</html>
